{% extends "base.html" %}

{% block title %}Dashboard - Task Manager{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
  <div class="header-content">
    <div class="page-title-section">
      <h1 class="gradient-text">
        <i class="fas fa-tasks"></i> 
        Task Dashboard
      </h1>
      <p class="page-subtitle">Manage and track your tasks efficiently</p>
    </div>
  </div>
</div>

<!-- Add Task Form -->
<div id="addForm" class="add-task-form" style="display: none;">
  <form action="/add" method="POST" class="modern-form compact">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="form-header">
      <h3><i class="fas fa-plus-circle"></i> Create New Task</h3>
      <button type="button" class="close-btn" data-action="toggle-form">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="form-group required">
      <label for="task-name">Task Name</label>
      <input id="task-name" name="task" placeholder="Enter your task description..." required>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="due-date">Due Date</label>
        <input id="due-date" type="date" name="due">
      </div>
      <div class="form-group">
        <label for="priority">Priority Level</label>
        <select id="priority" name="priority">
          <option value="high">ðŸ”´ High Priority</option>
          <option value="medium" selected>ðŸŸ¡ Medium Priority</option>
          <option value="low">ðŸŸ¢ Low Priority</option>
        </select>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-check"></i>
        Create Task
      </button>
      <button type="button" class="btn btn-secondary" data-action="toggle-form">
        <i class="fas fa-times"></i>
        Cancel
      </button>
    </div>
  </form>
</div>

<!-- Main Tasks Section -->
<div class="tasks-section">
  <!-- Task Filters -->
  <div class="task-filters-section">
    <div class="filters-header">
      <h3>Filter Tasks</h3>
    </div>
    <div class="task-filters-modern">
      <a href="?filter=all" class="filter-chip {{ 'active' if current_filter == 'all' else '' }}">
        <i class="fas fa-list"></i>
        <span>All Tasks</span>
        <span class="filter-count">{{ (tasks | length) + (completed | length) }}</span>
      </a>
      <a href="?filter=today" class="filter-chip {{ 'active' if current_filter == 'today' else '' }}">
        <i class="fas fa-calendar-day"></i>
        <span>Today</span>
      </a>
      <a href="?filter=upcoming" class="filter-chip {{ 'active' if current_filter == 'upcoming' else '' }}">
        <i class="fas fa-clock"></i>
        <span>Upcoming</span>
      </a>
      <a href="?filter=overdue" class="filter-chip {{ 'active' if current_filter == 'overdue' else '' }}">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Overdue</span>
      </a>
    </div>
  </div>
  
  <!-- Pending Tasks Section -->
  {% if tasks %}
  <div class="task-section">
    <div class="section-header">
      <h3 class="section-title-modern">
        <i class="fas fa-tasks"></i>
        Pending Tasks
        <span class="task-count-badge">{{ tasks | length }}</span>
      </h3>
      <button class="btn-compact btn-primary" data-action="toggle-form">
        <i class="fas fa-plus"></i>
        <span>Add Task</span>
      </button>
    </div>
    <div id="taskList" class="tasks-grid">
      {% for task in tasks %}
      {% set task_index = loop.index0 %}
      <div class="task-card" data-index="{{ task_index }}">
        <div class="task-card-inner">
          <!-- Task Card Main Content -->
          <div class="task-card-main">
            <!-- Task Card Header -->
            <div class="task-card-header">
              <h3 class="task-title">{{ task.title }}</h3>
              <div class="task-priority-badge priority-{{ task.priority }}">
                <i class="fas fa-flag"></i>
                {{ task.priority | title }}
              </div>
            </div>
            
            <!-- Task Progress Bar -->
            {% if task.subtasks %}
            {% set completed_subtasks = task.subtasks | selectattr('completed') | list | length %}
            {% set total_subtasks = task.subtasks | length %}
            {% set task_progress = (completed_subtasks / total_subtasks * 100) if total_subtasks > 0 else 0 %}
            <div class="task-progress-bar">
              <div class="progress-bar-header">
                <span class="progress-label">Progress</span>
                <span class="progress-percentage">{{ "%.0f"|format(task_progress) }}%</span>
              </div>
              <div class="progress-track">
                <div class="progress-fill-bar" style="width: {{ task_progress }}%"></div>
              </div>
            </div>
            {% else %}
            <div class="task-progress-bar">
              <div class="progress-bar-header">
                <span class="progress-label">Progress</span>
                <span class="progress-percentage">0%</span>
              </div>
              <div class="progress-track">
                <div class="progress-fill-bar" style="width: 0%"></div>
              </div>
            </div>
            {% endif %}
            
            <!-- Task Card Content -->
            <div class="task-card-content">
              {% if task.description %}
              <div class="task-description">
                <p>{{ task.description }}</p>
              </div>
              {% endif %}
              
              <div class="task-meta">
                <span class="task-due">
                  <i class="fas fa-calendar"></i>
                  {{ task.due or 'No due date' }}
                </span>
                <span class="task-created">
                  <i class="fas fa-clock"></i>
                  Created {{ task.created_at.strftime('%m/%d') }}
                </span>
              </div>
              
              {% if task.subtasks %}
              {% set completed_subtasks = task.subtasks | selectattr('completed') | list | length %}
              {% set total_subtasks = task.subtasks | length %}
              
              <button class="subtasks-toggle" data-action="toggle-subtasks" data-task-index="{{ task_index }}" aria-expanded="false">
                <i class="fas fa-chevron-right"></i>
                View Subtasks ({{ completed_subtasks }}/{{ total_subtasks }})
              </button>
              
              <div class="subtasks-list" id="subtasks{{ task_index }}" style="display: none;">
                {% for sub in task.subtasks %}
                <div class="subtask-item {% if sub.completed %}completed{% endif %}">
                  <span class="subtask-text">{{ sub.title }}</span>
                  <div class="subtask-actions">
                    {% if not sub.completed %}
                    <form method="POST" action="{{ url_for('complete_subtask', tid=task.id, sid=sub.id) }}" style="display:inline;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-sm btn-success" title="Complete">
                        <i class="fas fa-check"></i>
                      </button>
                    </form>
                    {% endif %}
                    <form method="POST" action="{{ url_for('delete_subtask', tid=task.id, sid=sub.id) }}" style="display:inline;" onsubmit="return confirm('Delete this subtask?')">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </form>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Task Card Actions (Right Side) -->
          <div class="task-card-actions">
            <button class="btn-compact" data-action="toggle-subtask" data-task-index="{{ task_index }}">
              <i class="fas fa-plus"></i>
              <span>Add Subtask</span>
            </button>
            <!-- Replace GET links with POST forms including CSRF -->
            <form method="POST" action="{{ url_for('complete_task', tid=task.id) }}" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-compact btn-success">
                <i class="fas fa-check"></i>
                <span>Complete</span>
              </button>
            </form>
            <form method="POST" action="{{ url_for('delete_task', tid=task.id) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this task?')">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn-compact btn-danger">
                <i class="fas fa-trash"></i>
                <span>Delete</span>
              </button>
            </form>
          </div>
        </div>
        
        <!-- Subtask Form -->
        <form class="inline-form" id="subtaskForm{{ task_index }}" action="{{ url_for('add_subtask', tid=task.id) }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="form-group">
            <label for="subtask-{{ task_index }}">Subtask</label>
            <input type="text" id="subtask-{{ task_index }}" name="subtask" placeholder="Enter subtask name..." required>
          </div>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Add
          </button>
          <button type="button" class="btn btn-secondary" data-action="toggle-subtask" data-task-index="{{ task_index }}">
            <i class="fas fa-times"></i>
          </button>
        </form>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="empty-state-modern">
    <div class="empty-content">
      <div class="empty-icon">
        <i class="fas fa-tasks"></i>
      </div>
      <h3>No pending tasks</h3>
      <p>You're all caught up! Create a new task to get started.</p>
      <button class="btn-compact btn-primary" data-action="toggle-form">
        <i class="fas fa-plus"></i>
        <span>Add Your First Task</span>
      </button>
    </div>
  </div>
  {% endif %}
</div>

<!-- Completed Tasks -->
{% if completed %}
<div class="task-section completed-section">
  <div class="section-header">
    <h3 class="section-title-modern">
      <i class="fas fa-check-circle"></i>
      Completed Tasks
      <span class="task-count-badge completed">{{ completed | length }}</span>
    </h3>
  </div>
  
  <div class="tasks-grid">
    {% for task in completed %}
    <div class="task-card completed">
      <!-- Task Card Header -->
      <div class="task-card-header">
        <h3 class="task-title">{{ task.title }}</h3>
        <div class="task-priority-badge priority-{{ task.priority }}">
          <i class="fas fa-flag"></i>
          {{ task.priority | title }}
        </div>
      </div>
      
      <!-- Task Card Content -->
      <div class="task-card-content">
        <div class="task-meta">
          <span class="task-due">
            <i class="fas fa-calendar"></i>
            {{ task.due or 'No due date' }}
          </span>
        </div>
        
        {% if task.subtasks %}
        <div class="task-progress">
          <div class="progress-header">
            <span class="progress-title">All Subtasks Completed</span>
            <span class="progress-text">100% ({{ task.subtasks|length }}/{{ task.subtasks|length }})</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill completed-progress" style="width: 100%"></div>
          </div>
        </div>
        
        <button class="subtasks-toggle" data-action="toggle-subtasks" data-task-index="completed-{{ loop.index0 }}" aria-expanded="false">
          <i class="fas fa-chevron-right"></i>
          View Subtasks ({{ task.subtasks | length }})
        </button>
        
        <div class="subtasks-list" id="subtasksCompleted{{ loop.index0 }}" style="display: none;">
          {% for sub in task.subtasks %}
          <div class="subtask-item completed">
            <span class="subtask-text">{{ sub.title }}</span>
            <i class="fas fa-check-circle completed-icon" style="color: var(--success-color);"></i>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      
      <!-- Task Card Actions -->
      <div class="task-card-actions">
        <span class="completed-badge" style="background: rgba(16, 185, 129, 0.2); color: var(--success-color); padding: 8px 16px; border-radius: 20px; font-weight: 500; display: flex; align-items: center; gap: 6px; justify-content: center;">
          <i class="fas fa-check-circle"></i>
          Completed
        </span>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<script>
// Modern event handling with data attributes
document.addEventListener('DOMContentLoaded', function() {
  // Form toggle functionality
  function toggleForm() { 
    const form = document.getElementById('addForm');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
    form.classList.toggle('show');
  }

  function toggleSubtaskForm(taskIndex) {
    const form = document.getElementById('subtaskForm' + taskIndex);
    form.classList.toggle('show');
    if (form.classList.contains('show')) {
      const input = form.querySelector('input[name="subtask"]');
      if (input) input.focus();
    }
  }

  function toggleSubtasks(taskIndex) {
    const subtasksList = document.getElementById('subtasks' + taskIndex) || 
                        document.getElementById('subtasksCompleted' + taskIndex.replace('completed-', ''));
    const toggleButton = document.querySelector(`[data-task-index="${taskIndex}"]`);
    
    if (subtasksList && toggleButton) {
      const isExpanded = subtasksList.style.display !== 'none';
      subtasksList.style.display = isExpanded ? 'none' : 'block';
      toggleButton.setAttribute('aria-expanded', !isExpanded);
      
      const icon = toggleButton.querySelector('i');
      if (icon) {
        icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
      }
    }
  }

  // Event delegation for all button actions
  document.addEventListener('click', function(e) {
    // Check for data-action on the clicked element or its parent
    const actionElement = e.target.closest('[data-action]') || 
                         e.target.closest('.btn[data-action]') || 
                         e.target.closest('.btn-modern[data-action]');
    
    if (!actionElement) return;
    
    const action = actionElement.dataset.action;
    
    switch(action) {
      case 'toggle-form':
        e.preventDefault();
        toggleForm();
        break;
      case 'toggle-subtask':
        e.preventDefault();
        const taskIndex = actionElement.dataset.taskIndex;
        if (taskIndex !== undefined) {
          toggleSubtaskForm(taskIndex);
        }
        break;
      case 'toggle-subtasks':
        e.preventDefault();
        const subtaskTaskIndex = actionElement.dataset.taskIndex;
        if (subtaskTaskIndex !== undefined) {
          toggleSubtasks(subtaskTaskIndex);
        }
        break;
    }
  });

  // Sortable functionality
  const taskList = document.getElementById('taskList');
  if (taskList && typeof Sortable !== 'undefined') {
    new Sortable(taskList, { 
      animation: 200, 
      handle: '.task-card-content', 
      onEnd: function(evt) { 
        const order = [...document.querySelectorAll('#taskList .task-card')].map(el => parseInt(el.dataset.index)); 
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        fetch('/reorder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify(order)
        }).catch(console.error);
      } 
    });
  }
});
</script>

{% endblock %}
