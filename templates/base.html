<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}Task Manager{% endblock %}</title>

  <!-- CSRF token for JS -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- Core CSS (shared across all pages) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <!-- Page-specific CSS -->
  {% if request.endpoint == 'index' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/dashboard.css') }}">
  {% elif request.endpoint == 'all_projects' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/projects.css') }}">
  {% elif request.endpoint == 'create_project' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/create-project.css') }}">
  {% elif request.endpoint == 'project_detail' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/project-detail.css') }}">
  {% elif request.endpoint == 'focus_timer' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/focus-timer.css') }}">
  {% elif request.endpoint == 'workspaces' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/workspaces.css') }}">
  {% elif request.endpoint == 'create_workspace' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/create-workspace.css') }}">
  {% elif request.endpoint == 'workspace_detail' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/workspace-detail.css') }}">
  {% elif request.endpoint == 'profile' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/profile.css') }}">
  {% elif request.endpoint == 'settings' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/settings.css') }}">
  {% endif %}

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  
  <!-- Vercel Analytics (Web Analytics) -->
  <script defer src="/_vercel/insights/script.js"></script>
</head>
<body class="{% if current_user.is_authenticated %}{{ current_user.theme_preference or 'light' }}{% else %}light{% endif %} page-{{ request.endpoint or 'default' }}">
  {% if current_user.is_authenticated %}
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand"><i class="fas fa-folder-open"></i><h2>Dashboard</h2></div>
      <nav class="nav-links">
        <a href="{{ url_for('index', filter='all') }}" {% if request.endpoint == 'index' and request.args.get('filter', 'all') == 'all' %}class="active"{% endif %}><i class="fas fa-list"></i> All Tasks</a>
        <a href="{{ url_for('all_projects') }}" {% if request.endpoint == 'all_projects' %}class="active"{% endif %} class="nav-secondary"><i class="fas fa-folder"></i> All Projects</a>
        <div class="nav-divider"></div>
        <a href="{{ url_for('focus_timer') }}" {% if request.endpoint == 'focus_timer' %}class="active"{% endif %} class="nav-focus"><i class="fas fa-bullseye"></i> Focus Timer</a>
        <a href="{{ url_for('workspaces') }}" {% if request.endpoint in ['workspaces', 'create_workspace', 'workspace_detail'] %}class="active"{% endif %} class="nav-secondary"><i class="fas fa-building"></i> Workspaces</a>
        <div class="nav-divider"></div>
        <a href="{{ url_for('profile') }}" {% if request.endpoint == 'profile' %}class="active"{% endif %} class="nav-secondary"><i class="fas fa-user"></i> Profile</a>
        <a href="{{ url_for('settings') }}" {% if request.endpoint == 'settings' %}class="active"{% endif %} class="nav-secondary"><i class="fas fa-cog"></i> Settings</a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-profile-section">
          <div class="user-info">
            {% if current_user.profile_picture %}
              <img src="{{ url_for('uploaded_file', filename=current_user.profile_picture) }}" alt="Profile" class="user-avatar-small">
            {% else %}
              <div class="user-avatar-placeholder"><i class="fas fa-user"></i></div>
            {% endif %}
            <div class="user-details">
              <div class="user-name">{{ current_user.full_name or current_user.email.split('@')[0] }}</div>
              <div class="user-email">{{ current_user.email }}</div>
            </div>
          </div>
        </div>
        <div class="sidebar-actions">
          <button id="darkToggle" class="action-btn">
            <i class="fas fa-moon"></i> Dark Mode
          </button>
          <form method="POST" action="{{ url_for('logout') }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="action-btn logout-btn">
              <i class="fas fa-sign-out-alt"></i>
              <span>Sign Out</span>
            </button>
          </form>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="main-content">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for category, msg in messages %}
          <div class="flash flash-{{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    // Dark mode toggle
    document.addEventListener('DOMContentLoaded', function() {
      const toggle = document.getElementById('darkToggle');
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      if (toggle) {
        // Set initial icon based on current theme
        const isDarkInitially = document.body.classList.contains('dark');
        toggle.innerHTML = isDarkInitially ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
        
        toggle.addEventListener('click', function() {
          document.body.classList.toggle('dark');
          const isDark = document.body.classList.contains('dark');
          
          // Update toggle icon
          toggle.innerHTML = isDark ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
          
          // Save theme preference (include CSRF)
          fetch('/settings', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrfToken
            },
            body: 'theme=' + (isDark ? 'dark' : 'light')
          });
        });
      }
    });
  </script>

  {% else %}
  <!-- Redirect to login if not authenticated -->
  <script>
    window.location.href = "{{ url_for('login') }}";
  </script>
  {% endif %}
</body>
</html>
